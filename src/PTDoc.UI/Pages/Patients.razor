@page "/patients"
@attribute [Authorize]
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<PageTitle>Patients - PTDoc</PageTitle>

<div class="patients-page">
    <GlobalPageHeader OnPrimaryAction="OpenAddPatientModal" />

    <div class="patients-page-body">
        <div class="patients-page-search">
            <PatientSearchInput 
                @bind-Value="searchQuery" 
                Placeholder="Search by name or DOB" 
            />
        </div>

        <div class="patients-page-content">
            @if (isLoading)
            {
                <div class="patients-page-loading">
                    <p>Loading patients...</p>
                    @* TODO: Replace with LoadingSkeleton component *@
                </div>
            }
            else
            {
                <PatientCardSection 
                    Items="@GetFilteredPatients()" 
                    OnCardClick="@HandlePatientClick" 
                />
            }
        </div>
    </div>
</div>

<AddPatientModal 
    @bind-IsOpen="isAddPatientModalOpen"
    OnSubmit="@HandleAddPatient"
/>

@code {
    private bool isLoading = false;
    private bool isAddPatientModalOpen = false;
    private string searchQuery = string.Empty;
    private List<PatientListItemVm> patients = new();

    protected override void OnInitialized()
    {
        // TODO: Replace with actual service call to fetch patients
        LoadSampleData();
    }

    private void LoadSampleData()
    {
        patients = new List<PatientListItemVm>
        {
            new()
            {
                Id = "1",
                DisplayName = "Sarah Johnson",
                DateOfBirth = "Mar 14, 1985",
                LastVisit = "Sep 30, 2024",
                StatusLabel = "Active",
                StatusVariant = BadgeVariant.Success
            },
            new()
            {
                Id = "2",
                DisplayName = "Michael Chen",
                DateOfBirth = "Jul 21, 1992",
                LastVisit = "Sep 27, 2024",
                StatusLabel = "Active",
                StatusVariant = BadgeVariant.Success
            },
            new()
            {
                Id = "3",
                DisplayName = "Emily Rodriguez",
                DateOfBirth = "Nov 7, 1978",
                LastVisit = "Sep 14, 2024",
                StatusLabel = "Pending",
                StatusVariant = BadgeVariant.Warning
            },
            new()
            {
                Id = "4",
                DisplayName = "James Williams",
                DateOfBirth = "Feb 3, 1990",
                LastVisit = "Sep 5, 2024",
                StatusLabel = "Active",
                StatusVariant = BadgeVariant.Success
            },
            new()
            {
                Id = "5",
                DisplayName = "Lisa Anderson",
                DateOfBirth = "May 18, 1982",
                LastVisit = "Aug 22, 2024",
                StatusLabel = "Active",
                StatusVariant = BadgeVariant.Success
            },
            new()
            {
                Id = "6",
                DisplayName = "Robert Martinez",
                DateOfBirth = "Dec 9, 1975",
                LastVisit = "Aug 10, 2024",
                StatusLabel = "Inactive",
                StatusVariant = BadgeVariant.Default
            }
        };
    }

    private IReadOnlyList<PatientListItemVm> GetFilteredPatients()
    {
        if (string.IsNullOrWhiteSpace(searchQuery))
        {
            return patients;
        }

        // TODO: Implement proper search logic with service integration
        var query = searchQuery.ToLowerInvariant();
        var filtered = patients.Where(p => 
            p.DisplayName.ToLowerInvariant().Contains(query) ||
            (p.DateOfBirth?.ToLowerInvariant().Contains(query) ?? false)
        ).ToList();
        return filtered;
    }

    private void OpenAddPatientModal()
    {
        isAddPatientModalOpen = true;
    }

    private void HandleAddPatient(AddPatientModal.PatientFormData formData)
    {
        _ = formData;
    }

    private void HandlePatientClick(PatientListItemVm patient)
    {
        NavigationManager.NavigateTo($"/patient/{patient.Id}");
    }
}
