@page "/appointments"
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Appointments - PTDoc</PageTitle>

<div class="appointments-page">
    <GlobalPageHeader OnPrimaryAction="HandleNewAppointment" />

    <div class="appointments-content">
        <AppointmentsLeftColumn SelectedView="@selectedView"
                               OnViewChanged="HandleViewChanged"
                               SelectedDate="@selectedDate"
                               OnPrevDay="HandlePrevDay"
                               OnNextDay="HandleNextDay"
                               OnToday="HandleToday"
                               TotalCount="12"
                               InProgressCount="1"
                               CheckedInCount="1"
                               MissingIntakeCount="2"
                               IsFiltersOpen="@isFiltersOpen"
                               IsFiltersOpenChanged="@((value) => isFiltersOpen = value)"
                               CurrentFilter="@currentFilter"
                               OnFilterChanged="HandleFilterChanged" />
        
        <AppointmentsRightColumn ViewLabel="@GetViewLabel()"
                                SelectedDate="@selectedDate"
                                View="@selectedView"
                                Filter="@currentFilter" />
    </div>
</div>

<!-- New Appointment Modal -->
<NewAppointmentModal IsOpen="@isNewAppointmentModalOpen"
                    IsOpenChanged="@((value) => isNewAppointmentModalOpen = value)"
                    OnSubmit="@HandleAppointmentSubmit" />

@code {
    private AppointmentsView selectedView = AppointmentsView.Today;
    private DateTime selectedDate = DateTime.Today;
    private bool isFiltersOpen = false;
    private AppointmentsFilter currentFilter = new();
    private bool isNewAppointmentModalOpen = false;

    [Inject] private NavigationManager NavigationManager { get; set; } = default!;

    private void HandleViewChanged(AppointmentsView view)
    {
        selectedView = view;
    }

    private void HandlePrevDay()
    {
        selectedDate = selectedDate.AddDays(-1);
    }

    private void HandleNextDay()
    {
        selectedDate = selectedDate.AddDays(1);
    }

    private void HandleToday()
    {
        selectedDate = DateTime.Today;
    }

    private void HandleFilterChanged(AppointmentsFilter filter)
    {
        currentFilter = filter;
        // In a real app, this would trigger data refresh with filters applied
    }

    private void HandleNewAppointment()
    {
        isNewAppointmentModalOpen = true;
    }

    private async Task HandleAppointmentSubmit(NewAppointmentModal.AppointmentFormData formData)
    {
        _ = formData;
        await Task.CompletedTask;
    }

    private string GetViewLabel()
    {
        return selectedView == AppointmentsView.Today ? "Today's Appointments" : "Week Appointments";
    }
}
